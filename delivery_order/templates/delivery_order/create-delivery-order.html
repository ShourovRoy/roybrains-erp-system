{% extends 'delivery_order/delivery-order-base.html' %}

{% block style %}
<style>
    .hidden {
        display: none;
    }
</style>
{% endblock style %}


{% block delivery_content %}
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <form action="{% url 'create_delivery_order' %}" method="POST">
                    {% csrf_token %}
                    <h1>Create Delivery Order</h1>
                    {{form.management_form}}

                    <input type="hidden" name="ledger_id" value="{{request.GET.ledger_id}}">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.account_name.label}}
                                </label>
                                {{form.account_name}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.address.label}}
                                </label>
                                {{form.address}}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.phone_number.label}}
                                </label>
                                {{form.phone_number}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.date.label}}
                                </label>
                                {{form.date}}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.previous_due.label}}
                                </label>
                                {{form.previous_due}}
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.total_price.label}}
                                </label>
                                {{form.total_price}}
                            </div>

                        </div>
                        <div class="col-md-4">

                            <div class="py-2">
                                <label for="" class="form-label">
                                    {{form.grand_total.label}}
                                </label>
                                {{form.grand_total}}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="py-2 col-md-6">
                            <label for="" class="form-label">
                                {{form.payment_amount.label}}
                            </label>
                            {{form.payment_amount}}
                        </div>

                        <div class="py-2 col-md-6">
                            <label for="" class="form-label">
                                {{form.due_amount.label}}
                            </label>
                            {{form.due_amount}}
                        </div>
                        
                    </div>

                    <div class="py-2">
                        <label for="" class="form-label">
                            {{form.is_paid.label}}
                        </label>
                        {{form.is_paid}}
                    </div>

                    <button type="submit" class="btn btn-primary">Create Delivery Order</button>

                    <div id="added-products-section" class="py-3 hidden">

                        <h2>Products</h2>
            
                        <table border="1px">
                            {{formset.management_form}}
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Weight</th>
                                    <th>Label</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>

                            <tbody id="product-form-list">
                                {% for productForm in formset %}
                                    <tr class="product-form">
                                     
                                        <td>
                                            {{productForm.product_name}}
                                        </td>
                                        <td>
                                            {{productForm.weight}}
                                        </td>
                                        <td>
                                            {{productForm.unit_label}}
                                        </td>
                                        <td>
                                            {{productForm.quantity}}
                                        </td>
                                        <td>
                                            {{productForm.price}}
                                        </td>
                                       
                                        <td><input type="number" class="form-control total-field" readonly></td> <!-- âœ… New field -->
                                        
                                        <td>
                                           
                                            <li class="hidden">{{ productForm.DELETE }}</li>
                                            <button type="button" class="btn btn-sm btn-danger delete-product-btn">Delete</button>
                                           
                                        </td>
                                       
                                    </tr>
                                    {% endfor %}
                                    <tr id="empty-product-form" class="hidden"> 
                                        <td>
                                            {{formset.empty_form.product_name}}
                                        </td>
                                        <td>
                                            {{formset.empty_form.weight}}
                                        </td>
                                        <td>
                                            {{formset.empty_form.unit_label}}
                                        </td>
                                        <td>
                                            {{formset.empty_form.quantity}}
                                        </td>
                                        <td>
                                            {{formset.empty_form.price}}
                                        </td>
                                        <td><input type="number" class="form-control total-field" readonly></td>
                                        <td>
                                            <li class="hidden">{{ formset.empty_form.DELETE }}</li>
                                            <button type="button" class="btn btn-sm btn-danger delete-product-btn">Delete</button>
                                        </td>
                                    </tr> 
                            </tbody>
                        </table>
                    </div>
                </form>

            </div>

            <div class="col-md-6">
                <h4>Search Products</h4>
                <form method="post">

                    {% csrf_token %}              
                    <input 
                        class="form-control" 
                        placeholder="Start typing product name.." 
                        type="search" 
                        name="product_search" 
                        id="product_search" 
                        required 
                        hx-get="{% url 'search_inventory_products' %}"
                        hx-trigger="input changed delay:500ms, keyup[key=='Enter'], load"
                        hx-target="#search_result"
                    />
                </form>

                <div id="search_result" class="py-3">

                </div>
            
            </div>
        </div>
    </div>
</section>
{% endblock delivery_content %}


{% block script %}

<script>
    function setupAddMoreButtons() {
        const addButtons = document.querySelectorAll(".add-more-product");
        const totalNewForms = document.getElementById("id_items-TOTAL_FORMS");
        
        addButtons.forEach((button) => {
            if (!button.dataset.listenerAdded) {
                button.addEventListener("click", function (event) {
                    event.preventDefault();

                    document.getElementById("search_result").innerHTML = ""

                    const searchInput = document.getElementById("product_search");
                    if (searchInput) {
                        searchInput.value = "";
                        searchInput.focus();
                    }

                    const productName = button.dataset.name;
                    const productWeight = button.dataset.weight;
                    const productQty = button.dataset.quantity;
                    const productId = button.dataset.id;


                    const currentProductForms = document.getElementsByClassName("product-form");
                    let currentFormCount = currentProductForms.length;

                    const formCopyTarget = document.getElementById("product-form-list");
                    const copyEmptyFormEl = document.getElementById("empty-product-form").cloneNode(true);

                    copyEmptyFormEl.setAttribute("class", "product-form");
                    copyEmptyFormEl.setAttribute("id", `form-${currentFormCount}`);

                    const regex = new RegExp("__prefix__", "g");
                    copyEmptyFormEl.innerHTML = copyEmptyFormEl.innerHTML.replace(regex, currentFormCount);

                    totalNewForms.setAttribute("value", currentFormCount + 1);
                    formCopyTarget.append(copyEmptyFormEl);

                    // Now fill the new form with product data
                    const newForm = formCopyTarget.lastElementChild;
                    const nameInput = newForm.querySelector('input[name$="-product_name"]');
                    const weightInput = newForm.querySelector('input[name$="-weight"]');
                    const qtyInput = newForm.querySelector('input[name$="-quantity"]');
                    const priceInput = newForm.querySelector('input[name$="-price"]');
                    const totalInput = newForm.querySelector(".total-field");

                    if (nameInput) nameInput.value = productName;
                    if (weightInput) weightInput.value = productWeight;
                    if (qtyInput) qtyInput.value = 0;
                    if (priceInput) priceInput.value = "";

                    // Update total when quantity or price changes
                    [qtyInput, priceInput].forEach(input => {
                        input.addEventListener("input", function() {
                            const qty = parseFloat(qtyInput.value) || 0;
                            if (qty > Number(productQty)) {
                                alert(`${productName} has ${productQty} but you are trying to sell ${qty}`)
                                qtyInput.value = 0
                            } else {

                                const price = parseFloat(priceInput.value) || 0;
                                totalInput.value = (qty * price).toFixed(2);
                            }
                            calculateTotalPrice()
                        });
                    });

                    document.getElementById("added-products-section").classList.remove("hidden")

                    calculateTotalPrice()

                    console.log(`Added ${productName} to form #${currentFormCount}`);
                });

                button.dataset.listenerAdded = "true";
            }
        });
    }

    function setupDeleteButtonHandler() {
        const tableBody = document.getElementById("product-form-list");

        // Use event delegation â€” works for dynamically added elements too
        tableBody.addEventListener("click", function (event) {
            if (event.target.classList.contains("delete-product-btn")) {
                event.preventDefault();

                const form = event.target.closest(".product-form");
                const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');

                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                }

                // Hide the form visually
                form.style.display = "none";

                calculateTotalPrice()
                

                // ðŸ”¹ Hide the products section if no visible items remain
                const visibleForms = Array.from(document.querySelectorAll(".product-form"))
                    .filter(f => f.style.display !== "none");

                if (visibleForms.length === 0) {
                    document.getElementById("added-products-section").classList.add("hidden");
                }
            }
        });
    }


    function calculateTotalPrice() {
        let totalProductsBill = 0;

        document.querySelectorAll(".product-form").forEach((form) => {
            if (form.style.display === "none") return; // skip hidden forms

            const itemTotalInput = form.querySelector(".total-field");
            if (itemTotalInput) {
                totalProductsBill += parseFloat(itemTotalInput.value) || 0;
            }
        });

        const orderTotalPriceInput = document.getElementById("id_total_price");
        if (orderTotalPriceInput) {
            orderTotalPriceInput.value = totalProductsBill.toFixed(2);
        }

        const orderPreviousDueInput = document.getElementById("id_previous_due");
        const orderGrandTotalInput = document.getElementById("id_grand_total");
        if (orderGrandTotalInput && orderPreviousDueInput) {
            
            orderGrandTotalInput.value = Number(orderPreviousDueInput.value) + totalProductsBill;
            
        }
        

        {% comment %} update due amount {% endcomment %}
        calculateDueAmount()

    }

    {% comment %} calculate due amount {% endcomment %}
    function calculateDueAmount() {
        const payment_amount_input = document.getElementById("id_payment_amount")

        if (Number(payment_amount_input.value) < 0 ) {
            alert("Payment amount can not be negative")
            payment_amount_input.value = 0.0
        } else {

            const currentPaymentInputValue = payment_amount_input.value
            const orderGrandTotalInput = document.getElementById("id_grand_total");
    
            document.getElementById("id_due_amount").value = Number(orderGrandTotalInput.value) - currentPaymentInputValue
        }


    }

    document.addEventListener("DOMContentLoaded", () => {
        setupAddMoreButtons();
        setupDeleteButtonHandler();

        {% comment %} listen the paid amount input field {% endcomment %}
        const payment_amount_input = document.getElementById("id_payment_amount")
        const orderPreviousDueInput = document.getElementById("id_previous_due");
        const orderGrandTotalInput = document.getElementById("id_grand_total");
        const currentDueInput = document.getElementById("id_due_amount");
        if (orderGrandTotalInput && orderPreviousDueInput && currentDueInput) {
            
            orderGrandTotalInput.value = Number(orderPreviousDueInput.value) + 0;
            currentDueInput.value = orderGrandTotalInput.value
            
        }
        if(payment_amount_input){
            payment_amount_input.addEventListener("input", calculateDueAmount)
        }
    });
    document.body.addEventListener("htmx:afterSwap", setupAddMoreButtons);
</script>

{% endblock script %} 