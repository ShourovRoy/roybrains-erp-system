{% extends 'delivery_order/delivery-order-base.html' %}

{% block style %}
<style>
    /* Essential Logic Class */
    .hidden { display: none !important; }
    
    /* Theme Standards */
    .bg-canvas { background-color: #1a1d20 !important; }
    .bg-card-custom { background-color: #2b3035 !important; }
    
    .x-small-label { 
        font-size: 0.65rem; 
        font-weight: 800; 
        letter-spacing: 1px; 
        color: #adb5bd !important; 
        text-transform: uppercase;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Input Styling */
    input, select, textarea {
        background-color: #1a1d20 !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
        padding: 0.6rem 0.8rem !important;
        border-radius: 6px !important;
    }

    input:focus, select:focus {
        border-color: var(--bs-primary) !important;
        outline: none;
        box-shadow: none !important;
    }

    /* Table Design */
    .custom-table { width: 100%; border-collapse: collapse; }
    .custom-table th {
        background-color: rgba(0,0,0,0.2);
        padding: 12px;
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #6c757d;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .custom-table td {
        padding: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        vertical-align: middle;
    }
</style>
{% endblock style %}

{% block delivery_content %}
<section class="py-4 bg-canvas min-vh-100">
    <div class="container">
        <div class="row g-4">
            
            <div class="col-lg-7">
                <form action="{% url 'create_delivery_order' %}" method="POST" id="main-order-form">
                    {% csrf_token %}
                    {{form.management_form}}
                    <input type="hidden" name="ledger_id" value="{{request.GET.ledger_id}}">

                    <div class="card bg-card-custom border-0 shadow-sm overflow-hidden">
                        <div class="p-4 border-bottom border-secondary border-opacity-10">
                            <div class="d-flex align-items-center">
                                <div style="width: 4px; height: 24px; background-color: var(--bs-primary); border-radius: 2px;" class="me-3"></div>
                                <h4 class="fw-bold text-white mb-0">Delivery Order Details</h4>
                            </div>
                        </div>

                        <div class="card-body p-4">
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="x-small-label">{{form.account_name.label}}</label>
                                    {{form.account_name}}
                                </div>
                                <div class="col-md-6">
                                    <label class="x-small-label">{{form.date.label}}</label>
                                    {{form.date}}
                                </div>
                                <div class="col-md-6">
                                    <label class="x-small-label">{{form.phone_number.label}}</label>
                                    {{form.phone_number}}
                                </div>
                                <div class="col-md-6">
                                    <label class="x-small-label">{{form.address.label}}</label>
                                    {{form.address}}
                                </div>
                            </div>

                            <div class="p-3 rounded-3 mb-4" style="background-color: rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.03);">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="x-small-label">Prev. Due</label>
                                        {{form.previous_due}}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="x-small-label">Total Price</label>
                                        {{form.total_price}}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="x-small-label text-primary">Grand Total</label>
                                        {{form.grand_total}}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="x-small-label">Payment Received</label>
                                        {{form.payment_amount}}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="x-small-label text-warning">Remaining Due</label>
                                        {{form.due_amount}}
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check form-switch">
                                    {{form.is_paid}}
                                    <label class="ms-2 text-secondary small">Mark as Paid</label>
                                </div>
                                <button type="submit" class="btn btn-primary px-5 py-2 fw-bold shadow">
                                    Confirm & Create Order
                                </button>
                            </div>
                        </div>

                        <div id="added-products-section" class="border-top border-secondary border-opacity-10 hidden">
                            <div class="p-3 bg-black bg-opacity-10">
                                <h6 class="text-white mb-0 small text-uppercase fw-bold">Order Items</h6>
                            </div>
                            <div class="table-responsive">
                                <table class="custom-table text-white">
                                    {{formset.management_form}}
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Weight</th>
                                            <th>Label</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-form-list">
                                        {% for productForm in formset %}
                                        <tr class="product-form">
                                            <td>{{productForm.product_name}}</td>
                                            <td>{{productForm.weight}}</td>
                                            <td>{{productForm.unit_label}}</td>
                                            <td style="width: 80px;">{{productForm.quantity}}</td>
                                            <td style="width: 100px;">{{productForm.price}}</td>
                                            <td><input type="number" class="total-field" readonly style="width: 90px; border: none; background: transparent !important;"></td>
                                            <td>
                                                <li class="hidden">{{ productForm.DELETE }}</li>
                                                <button type="button" class="btn btn-link text-danger p-0 delete-product-btn"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        
                                        <tr id="empty-product-form" class="hidden"> 
                                            <td>{{formset.empty_form.product_name}}</td>
                                            <td>{{formset.empty_form.weight}}</td>
                                            <td>{{formset.empty_form.unit_label}}</td>
                                            <td>{{formset.empty_form.quantity}}</td>
                                            <td>{{formset.empty_form.price}}</td>
                                            <td><input type="number" class="total-field" readonly style="width: 90px; border: none; background: transparent !important;"></td>
                                            <td>
                                                <li class="hidden">{{ formset.empty_form.DELETE }}</li>
                                                <button type="button" class="btn btn-link text-danger p-0 delete-product-btn"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr> 
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-lg-5">
                <div class="card bg-card-custom border-0 shadow-sm">
                    <div class="card-body p-4">
                        <label class="x-small-label text-primary mb-3">Add Products to Order</label>
                        <div class="input-group mb-3">
                            <span class="input-group-text bg-dark border-0 text-secondary" style="background-color: #1a1d20 !important;">
                                <i class="bi bi-search"></i>
                            </span>
                            <input 
                                class="form-control border-0" 
                                placeholder="Search inventory..." 
                                type="search" 
                                name="product_search" 
                                id="product_search" 
                                hx-get="{% url 'search_inventory_products' %}"
                                hx-trigger="input changed delay:500ms, keyup[key=='Enter']"
                                hx-target="#search_result"
                                style="background-color: #1a1d20 !important;"
                            />
                        </div>
                        <div id="search_result" class="overflow-auto" style="max-height: 500px;">
                            </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>
{% endblock delivery_content %}

{% block script %}
<script>
    function setupAddMoreButtons() {
        const addButtons = document.querySelectorAll(".add-more-product");
        const totalNewForms = document.getElementById("id_items-TOTAL_FORMS");

        addButtons.forEach((button) => {
            if (!button.dataset.listenerAdded) {
                button.addEventListener("click", function (event) {
                    event.preventDefault();

                    document.getElementById("search_result").innerHTML = ""

                    const searchInput = document.getElementById("product_search");
                    if (searchInput) {
                        searchInput.value = "";
                        searchInput.focus();
                    }

                    const productName = button.dataset.name;
                    const productWeight = button.dataset.weight;
                    const productQty = button.dataset.quantity;
                    const productId = button.dataset.id;


                    const currentProductForms = document.getElementsByClassName("product-form");
                    let currentFormCount = currentProductForms.length;

                    const formCopyTarget = document.getElementById("product-form-list");
                    const copyEmptyFormEl = document.getElementById("empty-product-form").cloneNode(true);

                    copyEmptyFormEl.setAttribute("class", "product-form");
                    copyEmptyFormEl.setAttribute("id", `form-${currentFormCount}`);

                    const regex = new RegExp("__prefix__", "g");
                    copyEmptyFormEl.innerHTML = copyEmptyFormEl.innerHTML.replace(regex, currentFormCount);

                    totalNewForms.setAttribute("value", currentFormCount + 1);
                    formCopyTarget.append(copyEmptyFormEl);

                    const newForm = formCopyTarget.lastElementChild;
                    const nameInput = newForm.querySelector('input[name$="-product_name"]');
                    const weightInput = newForm.querySelector('input[name$="-weight"]');
                    const qtyInput = newForm.querySelector('input[name$="-quantity"]');
                    const priceInput = newForm.querySelector('input[name$="-price"]');
                    const totalInput = newForm.querySelector(".total-field");

                    if (nameInput) nameInput.value = productName;
                    if (weightInput) weightInput.value = productWeight;
                    if (qtyInput) qtyInput.value = 0;
                    if (priceInput) priceInput.value = "";

                    [qtyInput, priceInput].forEach(input => {
                        input.addEventListener("input", function() {
                            let qty = parseFloat(qtyInput.value) || 0;
                            if (qty > Number(productQty)) {
                                alert(`${productName} has ${productQty} but you are trying to sell ${qty}`)
                                qtyInput.value = 0
                                qty = 0
                            } 

                            const price = parseFloat(priceInput.value) || 0;
                            totalInput.value = (qty * price).toFixed(2);
                            calculateTotalPrice()
                        });
                    });

                    document.getElementById("added-products-section").classList.remove("hidden")
                    calculateTotalPrice()
                });
                button.dataset.listenerAdded = "true";
            }
        });
    }

    function setupDeleteButtonHandler() {
        const tableBody = document.getElementById("product-form-list");
        tableBody.addEventListener("click", function (event) {
            if (event.target.closest(".delete-product-btn")) {
                event.preventDefault();
                const form = event.target.closest(".product-form");
                const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
                if (deleteCheckbox) { deleteCheckbox.checked = true; }
                form.style.display = "none";
                calculateTotalPrice()
                const visibleForms = Array.from(document.querySelectorAll(".product-form"))
                    .filter(f => f.style.display !== "none");
                if (visibleForms.length === 0) {
                    document.getElementById("added-products-section").classList.add("hidden");
                }
            }
        });
    }

    function calculateTotalPrice() {
        let totalProductsBill = 0;
        document.querySelectorAll(".product-form").forEach((form) => {
            if (form.style.display === "none") return;
            const itemTotalInput = form.querySelector(".total-field");
            if (itemTotalInput) {
                totalProductsBill += parseFloat(itemTotalInput.value) || 0;
            }
        });
        const orderTotalPriceInput = document.getElementById("id_total_price");
        if (orderTotalPriceInput) {
            orderTotalPriceInput.value = totalProductsBill.toFixed(2);
        }
        const orderPreviousDueInput = document.getElementById("id_previous_due");
        const orderGrandTotalInput = document.getElementById("id_grand_total");
        if (orderGrandTotalInput && orderPreviousDueInput) {
            orderGrandTotalInput.value = (Number(orderPreviousDueInput.value) + totalProductsBill).toFixed(2);
        }
        calculateDueAmount()
    }

    function calculateDueAmount() {
        const payment_amount_input = document.getElementById("id_payment_amount")
        if (Number(payment_amount_input.value) < 0 ) {
            alert("Payment amount can not be negative")
            payment_amount_input.value = 0.0
        } else {
            const currentPaymentInputValue = payment_amount_input.value
            const orderGrandTotalInput = document.getElementById("id_grand_total");
            document.getElementById("id_due_amount").value = (Number(orderGrandTotalInput.value) - currentPaymentInputValue).toFixed(2);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        setupAddMoreButtons();
        setupDeleteButtonHandler();
        const payment_amount_input = document.getElementById("id_payment_amount")
        const orderPreviousDueInput = document.getElementById("id_previous_due");
        const orderGrandTotalInput = document.getElementById("id_grand_total");
        const currentDueInput = document.getElementById("id_due_amount");
        if (orderGrandTotalInput && orderPreviousDueInput && currentDueInput) {
            orderGrandTotalInput.value = Number(orderPreviousDueInput.value) + 0;
            currentDueInput.value = orderGrandTotalInput.value
        }
        if(payment_amount_input){
            payment_amount_input.addEventListener("input", calculateDueAmount)
        }
    });
    document.body.addEventListener("htmx:afterSwap", setupAddMoreButtons);
</script>
{% endblock script %}